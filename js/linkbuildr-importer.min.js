jQuery(function(e){e(document).ready(function(e){if(window.File&&window.FileReader&&window.FileList&&window.Blob){let e=document.getElementById("lb-importer-pre-form");e&&e.addEventListener("change",handleFileSelect,!1);let t=document.getElementById("lb-importer-data-form");t&&t.addEventListener("change",debounce(reValidateCellEvent,250),!1)}else{let e='<div class="summary error"><div class="lb-stat-body">The File APIs are not fully supported in this browser. Please use a&nbsp;<a href="https://developer.mozilla.org/en-US/docs/Web/API/File#Browser_compatibility" target="_blank" rel="nofollow">broswer that supports File APIs.</a></div></div>';document.getElementById("file-data-errors").innerHTML=e}e("#lb-importer-pre-form").submit(function(e){return e.preventDefault(),!1}),e("#lb-importer-data-form").submit(function(t){if(t.preventDefault(),"false"==e("#lb-submit-import").val())return!1;condenseForms(),e("#lb-importer-form").submit()})})});var tableheaderTHIdPrefix="lb-table-th-",tableheaderIdPrefix="lb-table-header-",tableheaderClass="lb-table-header",tableheaderDraggableClass="lb-table-header-draggable",tableheaderContainerIdPrefix="lb-table-header-container-",tableheaderContainerClass="lb-table-header-container",tableheaderEmptyContainerClass="lb-empty-header-container",linkbuildrInputRowClassPrefix="lb_inputs_in_row_",linkbuildrDataDelimiter="#zlbz#",linkbuildrImportDataName="lb_import_data",tableDataValidityKeyName="lb_import_data_validity",tableCellBaseClass="import-table-cell",tableCellClassPrefix="import-table-cell-",tableCellInvalidClass="lb-invalid-cell",tableRowSuccessClass="lb-row-success",tableRowErrorClass="lb-row-error",data_summary={},requiredColumns=["site","email","domain","name"];function handleFileSelect(e){clearDynamicContent();var t,a=e.target.files,l=[];if(null!=a){var r=new FileReader;if(r.onload=(t=a[0],function(e){l.push("<li><strong>",escape(t.name),"</strong> (",t.type||"n/a",") - ",t.size," bytes, last modified: ",t.lastModifiedDate?t.lastModifiedDate.toLocaleDateString():"n/a","</li>"),document.getElementById("file-details").innerHTML="<ul>"+l.join("")+"</ul>"}),"text/csv"===a[0].type)r.readAsText(a[0]),r.addEventListener("loadend",handleFileLoaded,!1);else{let e='<div class="summary error"><div class="lb-stat-body">Incorrect File Type, please only upload CSV formatted files.</div></div>';document.getElementById("file-data-errors").innerHTML=e}}}function handleFileLoaded(e){var t=e.currentTarget.result.split("\n"),a={header_first:!1,row_count:0,col_count:0,col_map:{}},l=[],r=0;if(scanFileForRequirements(t)){a.header_first=!0,r=1;var s=mapDataTypesFromHeaders(t[0].split(","));setColumnMap(s),a.col_map=s,a.col_count=Object.keys(s).length;for(var i,n=r;i=t[n];n++)l.push(i.split(","));data_summary=createDataTable(l,a),displaySummaryAndErrors()}}function scanFileForRequirements(e){let t=e.length,a=document.getElementById("php_max_input_vars").value;var l={isValid:!1,hasHeaders:!1,headersHaveDomain:!1,headersHaveSite:!1,headersHaveName:!1,headersHaveEmail:!1,columnCountValid:!1,rowCountValid:t<a-5};let r=e[0].split(","),s=r.length,i=!0;for(var n,d=0;n=r[d];d++)n.toLowerCase().includes("domain")||n.toLowerCase().includes("url")?l.headersHaveDomain=!0:n.toLowerCase().includes("site")?l.headersHaveSite=!0:n.toLowerCase().includes("email")?l.headersHaveEmail=!0:n.toLowerCase().includes("name")&&(l.headersHaveName=!0),(validateURL(n)||validateEmail(n))&&(i=!1);l.hasHeaders=i;var o;for(d=1;(o=e[d])&&!(d>a);d++){let e=o.split(",");e.length>s&&(s=e.length)}return 4>=s&&(l.columnCountValid=!0),l.hasHeaders&&l.headersHaveDomain&&l.headersHaveSite&&l.headersHaveName&&l.headersHaveEmail&&l.columnCountValid&&l.rowCountValid&&(l.isValid=!0),updateFileRequirements(l),l.isValid}function updateFileRequirements(e){if(e.isValid)document.getElementById("lb-file-requirements").classList.add("lb-file-valid"),document.getElementById("lb-file-requirements").classList.remove("lb-file-invalid");else{document.getElementById("lb-file-requirements").classList.add("lb-file-invalid"),document.getElementById("lb-file-requirements").classList.remove("lb-file-valid");let e='<div class="summary error"><div class="lb-stat-body"><span class="lb-big-num">Please resolve file requirement issues and try again.</span></div></div>';document.getElementById("file-data-errors").innerHTML=e}e.hasHeaders?(document.getElementById("lb-file-req-firstLine").classList.add("lb-req-passed"),document.getElementById("lb-file-req-firstLine").classList.remove("lb-req-failed")):(document.getElementById("lb-file-req-firstLine").classList.add("lb-req-failed"),document.getElementById("lb-file-req-firstLine").classList.remove("lb-req-passed")),e.headersHaveDomain?(document.getElementById("lb-file-req-includedHeaders-domain").classList.add("lb-req-passed"),document.getElementById("lb-file-req-includedHeaders-domain").classList.remove("lb-req-failed")):(document.getElementById("lb-file-req-includedHeaders-domain").classList.add("lb-req-failed"),document.getElementById("lb-file-req-includedHeaders-domain").classList.remove("lb-req-passed")),e.headersHaveSite?(document.getElementById("lb-file-req-includedHeaders-site").classList.add("lb-req-passed"),document.getElementById("lb-file-req-includedHeaders-site").classList.remove("lb-req-failed")):(document.getElementById("lb-file-req-includedHeaders-site").classList.add("lb-req-failed"),document.getElementById("lb-file-req-includedHeaders-site").classList.remove("lb-req-passed")),e.headersHaveName?(document.getElementById("lb-file-req-includedHeaders-name").classList.add("lb-req-passed"),document.getElementById("lb-file-req-includedHeaders-name").classList.remove("lb-req-failed")):(document.getElementById("lb-file-req-includedHeaders-name").classList.add("lb-req-failed"),document.getElementById("lb-file-req-includedHeaders-name").classList.remove("lb-req-passed")),e.headersHaveEmail?(document.getElementById("lb-file-req-includedHeaders-email").classList.add("lb-req-passed"),document.getElementById("lb-file-req-includedHeaders-email").classList.remove("lb-req-failed")):(document.getElementById("lb-file-req-includedHeaders-email").classList.add("lb-req-failed"),document.getElementById("lb-file-req-includedHeaders-email").classList.remove("lb-req-passed")),e.headersHaveDomain&&e.headersHaveSite&&e.headersHaveName&&e.headersHaveEmail?(document.getElementById("lb-file-req-includedHeaders").classList.add("lb-req-passed"),document.getElementById("lb-file-req-includedHeaders").classList.remove("lb-req-failed")):(document.getElementById("lb-file-req-includedHeaders").classList.add("lb-req-failed"),document.getElementById("lb-file-req-includedHeaders").classList.remove("lb-req-passed")),e.columnCountValid?(document.getElementById("lb-file-req-columnLimit").classList.add("lb-req-passed"),document.getElementById("lb-file-req-columnLimit").classList.remove("lb-req-failed")):(document.getElementById("lb-file-req-columnLimit").classList.add("lb-req-failed"),document.getElementById("lb-file-req-columnLimit").classList.remove("lb-req-passed")),e.rowCountValid?(document.getElementById("lb-file-req-rowLimit").classList.add("lb-req-passed"),document.getElementById("lb-file-req-rowLimit").classList.remove("lb-req-failed")):(document.getElementById("lb-file-req-rowLimit").classList.add("lb-req-failed"),document.getElementById("lb-file-req-rowLimit").classList.remove("lb-req-passed"))}function createDataTable(e,t){var a=document.getElementById("default_email_template_id"),l=0,r=0,s=0,i=0,n='<table class="import-contact-table">';n+="<thead>",n+="<tr>";for(var d,o=0;d=t.col_map[o];o++)n+='<th id="'+tableheaderTHIdPrefix+d+'"><div id="'+tableheaderContainerIdPrefix+o+'" class="'+tableheaderContainerClass+'" columnNumber="'+o+'" ondrop="dropHeader(event)" ondragover="allowDrop(event)"><div id="'+tableheaderIdPrefix+d+'" class="'+tableheaderClass+" "+tableheaderDraggableClass+" "+tableCellClassPrefix+d+'" columnNumber="'+o+'" dataTypeAssociation="'+d+'" draggable="true" ondragstart="dragHeader(event)">'+capitalizeFirstLetter(d)+"</div></div></th>";n+='<th id="'+tableheaderTHIdPrefix+'template"><div class="'+tableheaderClass+'">Email Template</div></th>',n+="</tr>",n+="</thead>",n+="<tbody>";for(o=0;o<e.length;o++){let d=e[o],u=!0,c="";for(var m=0;m<d.length;m++){let e=d[m],a=!0,l="",s="",i=tableCellBaseClass;"email"===t.col_map[m]&&((a=validateEmail(e))||(u=!1,r++),i+=" "+(s=tableCellClassPrefix+"email")),"domain"===t.col_map[m]&&((a=validateURL(e))||(u=!1,r++),i+=" "+(s=tableCellClassPrefix+"domain")),"site"===t.col_map[m]&&(i+=" "+(s=tableCellClassPrefix+"site")),"name"===t.col_map[m]&&(i+=" "+(s=tableCellClassPrefix+"name")),l=createInputMarkup("text",linkbuildrImportDataName+"["+o+"]["+m+"]","",linkbuildrInputRowClassPrefix+o,e),c+='<td class="'+(i+=a?"":" "+tableCellInvalidClass)+'">',c+=l,c+="</td>"}c+='<td class="'+tableCellBaseClass+" "+tableCellClassPrefix+'template">'+createRowSelect(o,a)+createInputMarkup("hidden",tableDataValidityKeyName+"["+o+"]","","",u)+"</td>",u?(n+='<tr class="'+tableRowSuccessClass+'">'+c+"</tr>",i++):(n+='<tr class="'+tableRowErrorClass+'">'+c+"</tr>",s++),l++}return n+="</tbody>",n+="</table>",document.getElementById("file-data-table-output").innerHTML=n,{row_count:l,valid_row_count:i,error_row_count:s,error_count:r}}function createInputMarkup(e,t,a="",l="",r=""){let s='<input type="'+e+'" name="'+t+'" ';return""!==a&&(s+='id="'+a+'" '),""!==l&&(s+='class="'+l+'" '),""!==r&&(s+='value="'+r+'" '),s+="/>"}function createRowSelect(e,t){let a=document.createElement("SELECT");return a.setAttribute("name","email_template_ids["+e+"]"),a.setAttribute("class",linkbuildrInputRowClassPrefix+e),a.innerHTML=t.innerHTML,a.options[t.selectedIndex].setAttribute("selected","selected"),a.outerHTML}function displaySummaryAndErrors(){if(0<data_summary.error_count){let e='<div class="summary error"><div class="lb-stat-body"><span class="lb-big-num">'+data_summary.error_count+" Error"+(data_summary.error_count>1?"s":"")+' </span> across <span class="lb-big-num">'+data_summary.error_row_count+" Row"+(data_summary.error_row_count>1?"s":"")+"</span> click in the erroring field"+(data_summary.error_count>1?"s":"")+" to edit</div></div>";document.getElementById("file-data-errors").innerHTML=e;let t='<div class="summary info"><div class="lb-stat-body"><span class="lb-big-num">'+(data_summary.row_count-data_summary.error_row_count)+' Valid Rows</span> out of <span class="lb-big-num">'+data_summary.row_count+" Total Rows</span></div></div>";document.getElementById("file-data-summary").innerHTML=t}else{let e='<div class="summary info"><div class="lb-stat-body"><span class="lb-big-num">'+data_summary.row_count+" Rows</span> of Contacts</div></div>";document.getElementById("file-data-summary").innerHTML=e,document.getElementById("file-data-errors").innerHTML=""}let e=document.getElementById("lb-submit-row");data_summary.row_count-data_summary.error_row_count>0?(e.classList.remove("lb-importer-submit-row"),document.getElementById("lb-submit-import").value=!0):e.classList.contains("lb-importer-submit-row")||(e.classList.add("lb-importer-submit-row"),document.getElementById("lb-submit-import").value=!1)}function mapDataTypesFromStore(){for(var e={},t=document.getElementsByClassName("lb-datamap-store"),a=t.length,l=0;l<a;l++){let a=parseInputNameKey(t[l].getAttribute("name")),r=t[l].value;"-"!=r&&(e[r]=a)}return e}function mapDataTypesFromHeaders(e){for(var t,a={},l=0;t=e[l];l++)t.toLowerCase().includes("domain")||t.toLowerCase().includes("url")?a[l]="domain":t.toLowerCase().includes("site")?a[l]="site":t.toLowerCase().includes("email")?a[l]="email":(t.toLowerCase().includes("name")||t.toLowerCase().includes("contact"))&&(a[l]="name");return a}function setColumnMap(e){for(var t in e)document.getElementsByName("columnMap["+e[t]+"]")[0].value=t}function updateDataMap(e,t){document.getElementsByName("columnMap["+e+"]")[0].value=t}function allowDrop(e){e.preventDefault()}function dragHeader(e){e.dataTransfer.setData("id",e.target.id),e.dataTransfer.setData("sourceColumn",e.target.getAttribute("columnNumber"))}function dropHeader(e){e.preventDefault();var t=e.target;t.className.includes(tableheaderContainerClass)||(t=t.parentElement);var a=document.getElementById("header-holder"),l=e.dataTransfer.getData("id"),r=document.getElementById(l),s=e.dataTransfer.getData("sourceColumn"),i=t.getAttribute("columnNumber"),n=r.getAttribute("dataTypeAssociation"),d=t.firstElementChild,o="";if(d&&(o=d.getAttribute("dataTypeAssociation"),d.setAttribute("columnNumber","-1"),a.appendChild(d),a.parentElement.classList.contains("hide")&&a.parentElement.classList.remove("hide"),updateDataMap(o,"-")),"-1"!=s){document.getElementById(tableheaderContainerIdPrefix+s).classList.add(tableheaderEmptyContainerClass)}r.setAttribute("columnNumber",i),updateDataMap(n,i),t.innerHTML="",t.classList.remove(tableheaderEmptyContainerClass),t.appendChild(r),reValidateColumn(s),reValidateColumn(i),a.children.length<=0&&a.parentElement.classList.add("hide")}function reValidateCellEvent(e){reValidateCell(e.target)}function reValidateCell(e){let t=mapDataTypesFromStore(),a=e,l=a.parentElement,r=a.parentElement.parentElement,s=parseInputNameKey(a.getAttribute("name")),i=s.col,n=s.row,d=!l.classList.contains(tableCellInvalidClass),o=d,m=!r.classList.contains(tableRowErrorClass),u=m;if(o="domain"===t[i]?validateURL(a.value):"email"!==t[i]||validateEmail(a.value)){d||(data_summary.error_count--,a.parentElement.classList.remove(tableCellInvalidClass)),u=!0;let e=r.children.length;for(var c=0;c<e;c++)r.children[c].classList.contains(tableCellInvalidClass)&&(u=!1);u&&(m||(data_summary.error_row_count--,r.classList.remove(tableRowErrorClass),r.classList.add(tableRowSuccessClass),document.getElementsByName(tableDataValidityKeyName+"["+n+"]")[0].value=!0))}else d&&(data_summary.error_count++,a.parentElement.classList.add(tableCellInvalidClass)),m&&(data_summary.error_row_count++,r.classList.add(tableRowErrorClass),r.classList.remove(tableRowSuccessClass),document.getElementsByName(tableDataValidityKeyName+"["+n+"]")[0].value=!1);displaySummaryAndErrors()}function reValidateColumn(e){if(e>-1)for(var t=0;t<data_summary.row_count;t++){reValidateCell(document.getElementsByClassName(linkbuildrInputRowClassPrefix+t)[e])}}function validateEmail(e){return!!/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(e.trim())}function validateURL(e){try{var t=new URL(e);return"https:"===t.protocol||"http:"===t.protocol}catch(e){return!1}}function validateURLRegex(e){return!!new RegExp("^(https?:\\/\\/)?((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.)+[a-z]{2,}|((\\d{1,3}\\.){3}\\d{1,3}))(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*(\\?[;&a-z\\d%_.~+=-]*)?(\\#[-a-z\\d_]*)?$","i").test(e)}function condenseForms(){let e=0,t=0,a="";for(var l=0;l<data_summary.row_count;l++){if("true"==document.getElementsByName(tableDataValidityKeyName+"["+l+"]")[0].value){let t=document.getElementsByClassName(linkbuildrInputRowClassPrefix+l),i=[];for(var r,s=0;r=t[s];s++)r.parentElement.parentElement.classList.contains("lb-row-error")||i.push(r.value);a+=createInputMarkup("hidden","lb-import-data["+e+"]","","",delimitValues(i)),e++}else t++}document.getElementById("lb-importer-skip-count").value=t,document.getElementById("lb-importer-form-rowData-container").innerHTML=a;let i=mapDataTypesFromStore();document.getElementById("lb-importer-form-columnMap-container").innerHTML=createInputMarkup("hidden","lb-colMap","","",delimitValues(i))}function delimitValues(e){let t="",a=!0;for(var l,r=0;l=e[r];r++)a?a=!1:t+=linkbuildrDataDelimiter,t+=l;return t}function parseInputNameKey(e){if(e.indexOf("[")==e.lastIndexOf("["))return e.substring(e.indexOf("[")+1,e.indexOf("]"));return{row:e.substring(e.indexOf("[")+1,e.indexOf("]")),col:e.substring(e.lastIndexOf("[")+1,e.lastIndexOf("]"))}}function capitalizeFirstLetter(e){return e.charAt(0).toUpperCase()+e.slice(1)}function clearDynamicContent(){document.getElementById("header-holder").innerHTML="",document.getElementById("header-holder").parentElement.classList.add("hide"),document.getElementById("file-data-errors").innerHTML="",document.getElementById("file-data-table-output").innerHTML="",document.getElementById("file-data-summary").innerHTML="",document.getElementById("file-details").innerHTML="";let e=document.getElementById("lb-message-notice-container");e&&(e.innerHTML="");let t=document.getElementsByClassName("lb-file-requirement-notice");for(var a,l=0;a=t[l];l++)a.classList.remove("lb-req-failed"),a.classList.remove("lb-req-passed");document.getElementById("lb-file-requirements").classList.remove("lb-file-invalid"),document.getElementById("lb-file-requirements").classList.remove("lb-file-valid"),document.getElementById("lb-submit-row").classList.add("lb-importer-submit-row"),document.getElementById("lb-submit-import").value=!1}function debounce(e,t,a){var l;return function(){var r=this,s=arguments,i=a&&!l;clearTimeout(l),l=setTimeout(function(){l=null,a||e.apply(r,s)},t),i&&e.apply(r,s)}}