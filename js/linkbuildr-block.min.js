const{apiFetch:apiFetch}=wp,{registerStore:registerStore,withSelect:withSelect}=wp.data,DEFAULT_STATE={notificationData:{}},linkbuildrNotificationActions={setPostNoficationData:t=>({type:"SET_POST_NOTIFICATION_DATA",notificationData:t}),fetchPostNotificationData:t=>({type:"FETCH_POST_NOTIFICATION_DATA",path:t}),receivePostNoficationData:t=>({type:"RECEIVE_POST_NOTIFICATION_DATA",path:t})},linkBuildrNotificationStore=registerStore("linkbuildr",{reducer(t=DEFAULT_STATE,i){switch(i.type){case"SET_POST_NOTIFICATION_DATA":return{...t,notificationData:i.notificationData}}return t},linkbuildrNotificationActions:linkbuildrNotificationActions,selectors:{receivePostNoficationData(t,i){const{notificationData:e}=t;return e}},controls:{RECEIVE_POST_NOTIFICATION_DATA:t=>apiFetch({path:t.path}),FETCH_POST_NOTIFICATION_DATA:t=>apiFetch({path:t.path})},resolvers:{*receivePostNoficationData(t,i){const e=yield linkbuildrNotificationActions.fetchPostNotificationData("linkbuildr/v1/postNotificationData/"+i);return linkbuildrNotificationActions.setPostNoficationData(e)}}}),{findIndex:findIndex}=lodash,LBnoticeId="lbPostContactDataNotice",LBpublishNoticeId="lbSentEmailOnPublishNotice";let LBPostEmailsNotSent=[],PostJustPublished=!1,wasSavingPost=wp.data.select("core/editor").isSavingPost(),wasAutosavingPost=wp.data.select("core/editor").isAutosavingPost(),wasPostPublished=wp.data.select("core/editor").isCurrentPostPublished(),postNotificationData={displayNotifications:!1,showCount:-1,postSiteContactInvalid:[]};function LinkbuildrUpdatePostNotificationData(t){return apiFetch({path:"linkbuildr/v1/postNotificationData/"+t}).then(t=>{linkBuildrNotificationStore.dispatch(linkbuildrNotificationActions.setPostNoficationData(t))})}function IndexOfLBNotice(){let t=wp.data.select("core/notices").getNotices();return findIndex(t,function(t){return t.id==LBnoticeId})}function IndexOfLBPublishNotice(){let t=wp.data.select("core/notices").getNotices();return findIndex(t,function(t){return t.id==LBpublishNoticeId})}function getInvalidContacts(t){let i=[];return t.length>0&&t.forEach(function(t){"false"==t.is_valid&&i.push(t)}),i}function getUnsentContacts(t){let i=[];return t.length>0&&t.forEach(function(t){"false"==t.is_sent&&i.push(t)}),i}function LinkbuildrHandlePublishNotice(t){IndexOfLBPublishNotice()>-1&&wp.data.dispatch("core/notices").removeNotice(LBpublishNoticeId);let i=0;"postSiteContact"in t&&t.postSiteContact.length>0&&t.postSiteContact.forEach(function(t){"true"==t.is_sent&&LBPostEmailsNotSent.forEach(function(e){e.id===t.id&&"false"==e.is_sent&&"true"==t.is_sent&&i++})}),i>0&&wp.data.dispatch("core/notices").createNotice("success lb-notice-success",i+(1==i?" outreach email sent.":" outreach emails sent."),{id:LBpublishNoticeId,isDismissible:!0}).then(()=>{if(document.querySelector(".lb-notice-success")){let t=document.querySelector(".lb-notice-success .components-notice__content");t&&0>t.innerHTML.indexOf("lb-logo-notice-span")&&(t.innerHTML='<span class="lb-logo-notice-span"></span><span class="lb-notice-content">'+t.innerHTML+"</span>")}})}function LinkbuildrHandleNotice(t){if(IndexOfLBNotice()>-1&&wp.data.dispatch("core/notices").removeNotice(LBnoticeId),t.showCount>0&&t.displayNotifications){let i=getInvalidContacts(t.postSiteContact);wp.data.dispatch("core/notices").createNotice("info lb-notice",t.showCount+(1==t.showCount?" website in your post needs":" websites in your post need")+" contact details added:",{id:LBnoticeId,isDismissible:!0,actions:[{url:"/wp-admin/admin.php?page=site-contact-form&id="+i[0].id+"&scid="+i[0].site_contact_id+"&nb=1&pid="+i[0].post_id+"&bid="+i[0].blog_id+"&TB_iframe=true",label:"Add Details",className:"thickbox"}]}).then(()=>{let t=document.querySelector(".lb-notice .components-notice__content a");if(t){t.className.indexOf("thickbox")<0&&(t.className+=" thickbox");let i=document.querySelector(".lb-notice .components-notice__content");i&&0>i.innerHTML.indexOf("lb-logo-notice-span")&&(i.innerHTML='<span class="lb-logo-notice-span"></span><span class="lb-notice-content">'+i.innerHTML+"</span>")}})}}function updatedPostNotificationData(){let t=wp.data.select("core/editor").getCurrentPostId();t&&LinkbuildrUpdatePostNotificationData(t).then(()=>{postNotificationData=wp.data.select("linkbuildr").receivePostNoficationData(null,t),LBPostEmailsNotSent=getUnsentContacts(postNotificationData.postSiteContact)})}wp.data.subscribe(function(){const t=wp.data.select("core/editor").isSavingPost(),i=wp.data.select("core/editor").isAutosavingPost(),e=wp.data.select("core/editor").isCurrentPostPublished(),o=wasSavingPost&&!t||wasAutosavingPost&&!i||!wasPostPublished&&e,n=!wasPostPublished&&e;if(wasSavingPost=t,wasAutosavingPost=i,wasPostPublished=e,o){let t=wp.data.select("core/editor").getCurrentPostId();t&&LinkbuildrUpdatePostNotificationData(t).then(()=>{postNotificationData=wp.data.select("linkbuildr").receivePostNoficationData(null,t),PostJustPublished?(LinkbuildrHandlePublishNotice(postNotificationData),PostJustPublished=!1):(LBPostEmailsNotSent=getUnsentContacts(postNotificationData.postSiteContact),n&&(PostJustPublished=!0)),LinkbuildrHandleNotice(postNotificationData)})}}),wp.domReady(function(){updatedPostNotificationData()}),function(t){var i=t.plugins.registerPlugin,e=t.editPost.PluginPostStatusInfo,o=t.editPost.PluginPrePublishPanel,n=t.element.createElement,a=t.components.CheckboxControl,s=t.components.PanelBody,c=t.data.withSelect,l=t.data.withDispatch,r=t.compose.compose;const d=(t,i)=>Object.keys(i).reduce((e,o)=>t[o]===i[o]?e:{...e,[o]:i[o]},{}),u=r(c(function(t,i){const e=t("core/editor").getEditedPostAttribute("meta"),o=t("core/editor").getCurrentPostAttribute("meta");return{meta:{...o,...e},oldMeta:o}}),l(function(t,i){return{onUpdateLBSendOnPublish:function(i,e,o){const n={...d(o,e),linkbuildr_send_email_on_publish:i};t("core/editor").editPost({meta:n})}}}))(function(t){return n(a,{label:"Send Linkbuildr Emails on Publish",checked:!!t.meta.linkbuildr_send_email_on_publish,onChange:function(){t.onUpdateLBSendOnPublish(!t.meta.linkbuildr_send_email_on_publish,t.meta,t.oldMeta)}})});var p=r(c(function(t,i){return{currentPostId:t("core/editor").getCurrentPostId()}}),c(function(t,i){return{postNotificationData:t("linkbuildr").receivePostNoficationData(null,i.currentPostId)}}))(function(t){return LinkbuildrHandleNotice(t.postNotificationData),null});i("linkbuildr-post-settings",{render:function(){return n(e,{className:"lb-guten-post-settings"},n(u),n(p))}});var f=r(c(function(t,i){return{lbPostEditMeta:t("core/editor").getEditedPostAttribute("meta").linkbuildr_send_email_on_publish}}))(function(t){var i=["Linkbuildr Emails:",n("span",{className:"editor-post-publish-panel__link",key:"label"},t.lbPostEditMeta?"Yes":"No")];return n(s,{title:i,initialOpen:!1},n(u))});i("linkbuildr-pre-publish-panel",{render:function(){return n(o,{className:"lb-pre-publish-panel"},n(f))}})}(window.wp);